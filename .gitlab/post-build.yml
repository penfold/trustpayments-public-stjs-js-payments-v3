### app-html
.build-app-html:
  extends: .utility-images-build
  variables:
    DOCKER_TARGET: 'app-html'
    DOCKERFILE_PATH: 'docker/app-html/Dockerfile'
    USE_PIPELINE_IMAGE: 'true'
  before_script:
    - cp -r "${ARTIFACTS_BUILD_PATH}/dist/" 'dist/'

.build-app-html-local:
  extends: .build-app-html
  stage: post-build
  variables:
    ARTIFACTS_BUILD_PATH: "${CI_PROJECT_DIR}/.local_sources"
    UTILITY_NAME: 'app-html-local'
    BUILD_ARGS_EXTRA: '--build-arg PIPELINE_WORKDIR=/pipeline --build-arg BUILD_TYPE=dev'

build-app-html-local-review:
  extends:
    - .build-app-html-local
    - .rules-when-review

build-app-html-local-release:
  extends:
    - .build-app-html-local
    - .rules-when-release

.build-app-html-mock:
  extends: .build-app-html
  stage: post-build
  variables:
    ARTIFACTS_BUILD_PATH: "${CI_PROJECT_DIR}/.mock_sources"
    UTILITY_NAME: 'app-html-mock'
    BUILD_ARGS_EXTRA: '--build-arg PIPELINE_WORKDIR=/pipeline --build-arg BUILD_TYPE=mock'

build-app-html-mock-review:
  extends:
    - .build-app-html-mock
    - .rules-when-review

build-app-html-mock-release:
  extends:
    - .build-app-html-mock
    - .rules-when-release

build-app-html-review:
  extends:
    - .build-app-html
    - .rules-when-review
  stage: post-build
  variables:
    ARTIFACTS_BUILD_PATH: "${CI_PROJECT_DIR}/.releases_sources"
    UTILITY_NAME: 'app-html-review'
    BUILD_ARGS_EXTRA: '--build-arg PIPELINE_WORKDIR=/pipeline --build-arg BUILD_TYPE=prod --build-arg LIBRARY_ARG=--library_url=https://library.securetrading.net:8443'

build-app-html-release:
  variables:
    UTILITY_NAME: 'app-html-release'
  extends:
    - .build-app-html
    - .rules-when-release
  stage: post-build
  before_script:
    - cp -r "${CI_PROJECT_DIR}/.releases_sources/dist/" dist/
    - export RELEASE_TAG=$(jq -r '.release_tag // empty' "${ARTIFACT_RELEASE_CICD_FILENAME}")
    - export CDN_HASH=$(jq -r '.cdn_hash // empty' "${ARTIFACT_RELEASE_CICD_FILENAME}")
    - export LIBRARY_ARG="--library_url=https://cdn.eu.trustpayments.com/js-payments-v3/${RELEASE_TAG}-${CDN_HASH}"
    - export BUILD_ARGS_EXTRA="--build-arg PIPELINE_WORKDIR=/pipeline --build-arg BUILD_TYPE=prod --build-arg LIBRARY_ARG=${LIBRARY_ARG}"

#### testing repo
.build-payments-tests:
  extends: .utility-images-build
  stage: post-build
  variables:
    UTILITY_NAME: 'payments-tests'
    DOCKERFILE_PATH: docker/payments_tests/Dockerfile
    BUILD_ARGS_EXTRA: --build-arg COPY_FROM=./tests

build-payments-tests-review:
  extends:
    - .build-payments-tests
    - .rules-when-review

build-payments-tests-release:
  extends:
    - .build-payments-tests
    - .rules-when-release

#### wiremock for testing repo
.build-wiremock:
  extends:
    - .utility-images-build
  stage: post-build
  variables:
    UTILITY_NAME: 'wiremock'
    BUILD_ARGS_EXTRA: --build-arg COPY_FROM=./tests

build-wiremock-review:
  extends:
    - .build-wiremock
    - .rules-when-review

build-wiremock-release:
  extends:
    - .build-wiremock
    - .rules-when-release
