.sentry upload sourcemaps:
  stage: deploy
  image: getsentry/sentry-cli
  script:
    - SENTRY_VERSION=$(echo $CI_COMMIT_TAG | cut -c2-)
    - sentry-cli releases new $SENTRY_VERSION
    - sentry-cli releases files $SENTRY_VERSION upload-sourcemaps --wait --validate --url-prefix $SENTRY_URL_PREFIX $SENTRY_SOURCEMAPS_DIR
    - sentry-cli releases set-commits --auto $SENTRY_VERSION
    - sentry-cli releases finalize $SENTRY_VERSION

sentry sourcemaps staging:
  extends: .sentry upload sourcemaps
  rules:
    - if: $CI_COMMIT_TAG && $CI_COMMIT_TAG !~ /^v\d+\.\d+\.\d+(-.+)?$/
      when: on_success
    - when: never
  dependencies:
    - build web staging
  needs: ["build web staging"]

sentry sourcemaps production:
  extends: .sentry upload sourcemaps
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+?$/
      when: on_success
    - when: never
  dependencies:
    - build web production
  needs: ["build web production"]
