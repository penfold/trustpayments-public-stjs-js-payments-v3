### About resource_group
# Browserstack allow us to run 5 parallel jobs, so we need to limit executing browserstack jobs to max 5 in the same time
# Even if Browserstack jobs from fast-tests will be ran, then we still have Queue (5), so it should not be an issue.
# Resource groups - https://docs.gitlab.com/ee/ci/yaml/#resource_group
# We will have 4 resource groups for review and 4 for release: extended_tests_release_1 - ... - extended_tests_release_4 and one reserved for review branches (extended_tests_review_1)
# It will assure that we won't use more than 5 parallel extended Browserstack tests jobs.

.extended-tests:
  extends:
    - .variables
    - .tags-gitlab-org-docker
  stage: extended-tests
  image: ${IMAGE_JS_PAYMENTS_TESTS}

.extended-tests-browserstack:
  extends:
    - .extended-tests
    - .component-tests
    - .component-tests-services
    - .browserstack
  variables:
    WORKDIR: ${IMAGE_JS_PAYMENTS_TESTS_WORKDIR}
  after_script:
    - mkdir -p ./tests/reports
    - mv /app/reports/* ./tests/reports/
  artifacts:
    paths:
      - ./tests/reports
    when: always

.visual-regression-tests:
  extends:
    - .extended-tests
    - .component-tests
    - .e2e-tests-services
    - .browserstack
  variables:
    WORKDIR: ${IMAGE_JS_PAYMENTS_TESTS_WORKDIR}
  # both .browserstack's and .e2e-tests' before script have to be combined in one and put here
  # since there is no way to combine 2 "befores" from 2 different jobs
  before_script:
    - BS_LOCAL_IDENTIFIER=gitlab_${CI_PIPELINE_ID}_${CI_JOB_NAME}_$(date +%Y-%m-%d_%H-%M-%S)
    - export BS_LOCAL_IDENTIFIER
    - wget --quiet https://www.browserstack.com/browserstack-local/BrowserStackLocal-linux-x64.zip
    - unzip BrowserStackLocal-linux-x64.zip
    - ./BrowserStackLocal ${BROWSERSTACK_ACCESS_KEY} --force-local --local-identifier ${BS_LOCAL_IDENTIFIER} --daemon start
    - test -n "${EMAIL_LOGIN:-}"
    - test -n "${EMAIL_PASSWORD:-}"
    - test -n "${JWT_ISS_KEY:-}"
    - test -n "${JWT_SECRET_KEY_BASE64:-}"
    - JWT_SECRET_KEY=$(echo ${JWT_SECRET_KEY_BASE64} | base64 -d)
    - export JWT_SECRET_KEY
    - test -n "${JWT_SECRET_KEY:-}"
  after_script:
    - mkdir -p ./tests/screenshots/actual && mkdir -p ./tests/screenshots/results && mkdir -p ./tests/reports
    - mv /app/screenshots/actual/* ./tests/screenshots/actual/
    - mv /app/screenshots/results/* ./tests/screenshots/results/
    - mv /app/reports/* ./tests/reports/
  artifacts:
    paths:
      - ./tests/screenshots
      - ./tests/reports
    when: always

.visual-regression-component-tests:
  extends:
    - .extended-tests-browserstack
  variables:
    WORKDIR: ${IMAGE_JS_PAYMENTS_TESTS_WORKDIR}
  after_script:
    - mkdir -p ./tests/screenshots/actual && mkdir -p ./tests/screenshots/results && mkdir -p ./tests/reports
    - mv /app/screenshots/actual/* ./tests/screenshots/actual/
    - mv /app/screenshots/results/* ./tests/screenshots/results/
    - mv /app/reports/* ./tests/reports/
  artifacts:
    paths:
      - ./tests/screenshots
      - ./tests/reports
    when: always

# smoke tests executed on review branches
.apple-test-browserstack-component-test:
  extends:
    - .extended-tests-browserstack
    - .rules-always
  variables:
    OS: "OS X"
    OS_VERSION: Mojave
    BROWSER: Safari
    BROWSER_VERSION: '12.1'

apple-test-part1-browserstack-component-test:
  extends: .apple-test-browserstack-component-test
  variables:
    POETRY_TAGS: apple_test_part1
  resource_group: extended_tests_review_1

apple-test-part2-browserstack-component-test:
  extends: .apple-test-browserstack-component-test
  variables:
    POETRY_TAGS: apple_test_part2
  resource_group: extended_tests_review_2

OSXCatalina-Safari-13.1-smoke-tests:
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    OS: OS X
    OS_VERSION: Catalina
    BROWSER: Safari
    BROWSER_VERSION: '13.1'
    POETRY_TAGS: $SMOKE_TESTS_TAG
  resource_group: extended_tests_review_3

win10-firefox-80.0-smoke-tests:
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    OS: Windows
    OS_VERSION: 10
    BROWSER: Firefox
    BROWSER_VERSION: '80.0'
    POETRY_TAGS: $SMOKE_TESTS_TAG
  resource_group: extended_tests_review_4

win10-IE-11.0-smoke-tests:
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    OS: Windows
    OS_VERSION: 10
    BROWSER: IE
    BROWSER_VERSION: '11.0'
    POETRY_TAGS: $SMOKE_TESTS_TAG
  resource_group: extended_tests_release_1

win10-chrome-85.0-visual-tests:
  extends:
    - .visual-regression-tests
    - .rules-when-release
  variables:
    OS: Windows
    OS_VERSION: 10
    BROWSER: Chrome
    BROWSER_VERSION: '85'
    POETRY_TAGS: visual_regression
  resource_group: extended_tests_release_2

SamsungGalaxyS10Plus-9.0-visual-tests:
  extends:
    - .visual-regression-tests
    - .rules-when-release
  variables:
    DEVICE: Samsung Galaxy S10 Plus
    OS_VERSION: '9.0'
    REAL_MOBILE: 'true'
    POETRY_TAGS: visual_regression
  resource_group: extended_tests_release_3

iPhoneXS-12-visual-tests:
  extends:
    - .visual-regression-component-tests
    - .rules-when-release
  variables:
    DEVICE: iPhone XS
    OS_VERSION: 12
    REAL_MOBILE: 'true'
    POETRY_TAGS: visual_regression_safari
  resource_group: extended_tests_release_4

OSXMojave-Safari-12.1-visual-tests:
  extends:
    - .visual-regression-component-tests
    - .rules-when-release
  variables:
    OS: OS X
    OS_VERSION: Mojave
    BROWSER: Safari
    BROWSER_VERSION: '12.1'
    POETRY_TAGS: visual_regression_safari
  resource_group: extended_tests_release_1

win10-chrome-85.0-visual-tests-styling:
  extends:
    - .visual-regression-tests
    - .rules-when-release
  variables:
    OS: Windows
    OS_VERSION: 10
    BROWSER: Chrome
    BROWSER_VERSION: '85'
    POETRY_TAGS: visual_regression_styling
  resource_group: extended_tests_release_2

SamsungGalaxyS10Plus-9.0-visual-tests-styling:
  extends:
    - .visual-regression-tests
    - .rules-when-release
  variables:
    DEVICE: Samsung Galaxy S10 Plus
    OS_VERSION: '9.0'
    REAL_MOBILE: 'true'
    POETRY_TAGS: visual_regression_styling
  resource_group: extended_tests_release_3

iPhoneXS-12-visual-tests-styling:
  extends:
    - .visual-regression-component-tests
    - .rules-when-release
  variables:
    DEVICE: iPhone XS
    OS_VERSION: 12
    REAL_MOBILE: 'true'
    POETRY_TAGS: visual_regression_styling
  resource_group: extended_tests_release_4

OSXMojave-Safari-12.1-visual-tests-styling:
  extends:
    - .visual-regression-component-tests
    - .rules-when-release
  variables:
    OS: OS X
    OS_VERSION: Mojave
    BROWSER: Safari
    BROWSER_VERSION: '12.1'
    POETRY_TAGS: visual_regression_styling
  resource_group: extended_tests_release_1

# smoke tests executed on master branch

iPhone8-11.0-smoke-tests:
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    DEVICE: iPhone 8
    OS_VERSION: 11
    REAL_MOBILE: 'true'
    POETRY_TAGS: $SMOKE_TESTS_TAG
  resource_group: extended_tests_release_1

win8.1-chrome-85.0-smoke-tests:
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    OS: Windows
    OS_VERSION: '8.1'
    BROWSER: chrome
    BROWSER_VERSION: '85.0'
    POETRY_TAGS: $SMOKE_TESTS_TAG
  resource_group: extended_tests_release_2

OSXCatalina-chrome-85.0-smoke-tests:
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    OS: OS X
    OS_VERSION: Catalina
    BROWSER: chrome
    BROWSER_VERSION: '85.0'
    POETRY_TAGS: $SMOKE_TESTS_TAG
  resource_group: extended_tests_release_3

OSXCatalina-firefox-80.0-smoke-tests:
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    OS: OS X
    OS_VERSION: Catalina
    BROWSER: Firefox
    BROWSER_VERSION: '80.0'
    POETRY_TAGS: $SMOKE_TESTS_TAG
  resource_group: extended_tests_release_1

.win10-Edge-85.0-smoke-tests: # TODO https://securetrading.atlassian.net/browse/STJS-660
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    OS: Windows
    OS_VERSION: 10
    BROWSER: Edge
    BROWSER_VERSION: '85.0'
    POETRY_TAGS: $SMOKE_TESTS_TAG
  resource_group: extended_tests_release_3

win10-Edge-18.0-smoke-tests:
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    OS: Windows
    OS_VERSION: 10
    BROWSER: Edge
    BROWSER_VERSION: '18.0'
    POETRY_TAGS: $SMOKE_TESTS_TAG
  resource_group: extended_tests_release_4

OSXHS-Safari-11.1-smoke-tests:
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    OS: OS X
    OS_VERSION: High Sierra
    BROWSER: Safari
    BROWSER_VERSION: '11.1'
    POETRY_TAGS: $SMOKE_TESTS_TAG
  resource_group: extended_tests_release_1

iPhoneXS-12-smoke-tests:
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    DEVICE: iPhone XS
    OS_VERSION: 12
    REAL_MOBILE: 'true'
    POETRY_TAGS: $SMOKE_TESTS_TAG
  resource_group: extended_tests_release_2

iPad7th-13-smoke-tests:
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    DEVICE: iPad 7th
    OS_VERSION: 13
    REAL_MOBILE: 'true'
    POETRY_TAGS: $SMOKE_TESTS_TAG
  resource_group: extended_tests_release_3

GoogleNexus6-6.0-smoke-tests:
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    DEVICE: Google Nexus 6
    OS_VERSION: '6.0'
    REAL_MOBILE: 'true'
    POETRY_TAGS: $SMOKE_TESTS_TAG
  resource_group: extended_tests_release_4

SamsungGalaxyS8-7.0-smoke-tests:
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    DEVICE: Samsung Galaxy S8
    OS_VERSION: '7.0'
    REAL_MOBILE: 'true'
    POETRY_TAGS: $SMOKE_TESTS_TAG
  resource_group: extended_tests_release_1

SamsungGalaxyS10Plus-9.0-smoke-tests:
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    DEVICE: Samsung Galaxy S10 Plus
    OS_VERSION: '9.0'
    REAL_MOBILE: 'true'
    POETRY_TAGS: $SMOKE_TESTS_TAG
  resource_group: extended_tests_release_2

GooglePixel4-10.0-smoke-tests:
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    DEVICE: Google Pixel 4
    OS_VERSION: '10.0'
    REAL_MOBILE: 'true'
    POETRY_TAGS: $SMOKE_TESTS_TAG
  resource_group: extended_tests_release_3

# other tests executed on master branch

win10-Firefox-80.0-extended-tests:
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    OS: Windows
    OS_VERSION: 10
    BROWSER: Firefox
    BROWSER_VERSION: '80.0'
    POETRY_TAGS: $EXTENDED_TESTS_TAG
  resource_group: extended_tests_release_4

.iPhoneXR-12-full-test-part-1: # TODO https://securetrading.atlassian.net/browse/STJS-661
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    DEVICE: iPhone XR
    OS_VERSION: 12
    REAL_MOBILE: 'true'
    POETRY_TAGS: full_test_part_1
  resource_group: extended_tests_release_1

.iPhoneXR-12-full-test-part-2: # TODO https://securetrading.atlassian.net/browse/STJS-661
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    DEVICE: iPhone XR
    OS_VERSION: 12
    REAL_MOBILE: 'true'
    POETRY_TAGS: full_test_part_2
  resource_group: extended_tests_release_2

SamsungGalaxyS9-12-extended-test-part-1:
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    DEVICE: Samsung Galaxy S9
    OS_VERSION: '8.0'
    REAL_MOBILE: 'true'
    POETRY_TAGS: extended_tests_part_1
  resource_group: extended_tests_release_3

SamsungGalaxyS9-12-extended-test-part-2:
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    DEVICE: Samsung Galaxy S9
    OS_VERSION: '8.0'
    REAL_MOBILE: 'true'
    POETRY_TAGS: extended_tests_part_2
  resource_group: extended_tests_release_4

win10-IE-11.0-extended-test-part-1:
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    OS: Windows
    OS_VERSION: 10
    BROWSER: IE
    BROWSER_VERSION: '11.0'
    POETRY_TAGS: extended_tests_part_1
  resource_group: extended_tests_release_1

win10-IE-11.0-extended-test-part-2:
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    OS: Windows
    OS_VERSION: 10
    BROWSER: IE
    BROWSER_VERSION: '11.0'
    POETRY_TAGS: extended_tests_part_2
  resource_group: extended_tests_release_2

OSXMojave-Safari-12.1-extended-test-part-1:
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    OS: OS X
    OS_VERSION: Mojave
    BROWSER: Safari
    BROWSER_VERSION: '12.1'
    BROWSERSTACK_SELENIUM_VERSION: 3.14.0
    POETRY_TAGS: extended_tests_part_1
  resource_group: extended_tests_release_3

OSXMojave-Safari-12.1-extended-test-part-2:
  extends:
    - .extended-tests-browserstack
    - .rules-when-release
  variables:
    OS: OS X
    OS_VERSION: Mojave
    BROWSER: Safari
    BROWSER_VERSION: '12.1'
    BROWSERSTACK_SELENIUM_VERSION: 3.14.0
    POETRY_TAGS: extended_tests_part_2
  resource_group: extended_tests_release_4
