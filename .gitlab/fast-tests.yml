.headless-component-tests:
  extends: .fast-tests
  image: ${IMAGE_JS_PAYMENTS_TESTS}
  variables:
    BEHAVE_LOGGING_LEVEL: INFO
    FF_NETWORK_PER_BUILD: 'true' # https://docs.gitlab.com/runner/configuration/feature-flags.html
    FEATURE_FILES_DIR: 'features'
  services:
    - name: "${IMAGE_JS_PAYMENTS_APP_HTML_TEST}"
      alias: library.securetrading.net
    - name: "${IMAGE_JS_PAYMENTS_APP_HTML_TEST}"
      alias: merchant.securetrading.net
    - name: "${IMAGE_JS_PAYMENTS_WIREMOCK}"
      alias: webservices.securetrading.net
      command: ["--https-port", "8443", "--https-keystore", "/home/wiremock/keystore"]
    - name: "${IMAGE_JS_PAYMENTS_WIREMOCK}"
      alias: thirdparty.example.com
      command: ["--https-port", "8443", "--https-keystore", "/home/wiremock/keystore"]

.headless-component-tests-sequentially:
  extends: .headless-component-tests
  variables:
    FEATURE_FILE_NAME: '' # To be fill in child job - it have to be file name
  script:
    - . .cicd_scripts/tests/headless_component.sh
    - cd ${IMAGE_JS_PAYMENTS_TESTS_WORKDIR}
    - . venv/bin/activate
    - execute_headless_component_test_sequentially "${BEHAVE_LOGGING_LEVEL}" "${FEATURE_FILES_DIR}" "${FEATURE_FILE_NAME}"

.headless-component-tests-paralell:
  extends: .headless-component-tests
  variables:
    IGNORED_FILES: "TO-FILL" # list containing feature files that should not be run in parallel, eg. content: IGNORED_FILES="file1|file2"
    FEATURE_FILES_NAMES_CONTAINS: '' # To be fill in child job - it can be prefix, suffix or part of filenames
  script:
    - . .cicd_scripts/tests/headless_component.sh
    - cd ${IMAGE_JS_PAYMENTS_TESTS_WORKDIR}
    - . venv/bin/activate
    - execute_headless_component_test_in_parallel "${BEHAVE_LOGGING_LEVEL}" "${FEATURE_FILES_DIR}" "${FEATURE_FILES_NAMES_CONTAINS}"

card-payments-headless-component-tests:
  extends: .headless-component-tests-paralell
  variables:
    FEATURE_FILES_NAMES_CONTAINS: 'mock_'
  parallel: 16

visa-checkout-headless-component-tests:
  extends: .headless-component-tests-sequentially
  variables:
    FEATURE_FILE_NAME: 'visa_checkout_tests.feature'

extra-test:
  extends: .headless-component-tests
  script:
    - apt-get update && apt-get install -y wget curl
#    - wget -r --no-check-certificate https://merchant.securetrading.net
    - wget --content-on-error --no-check-certificate -O- https://webservices.securetrading.net:8443 || true
    - wget --content-on-error --no-check-certificate -O- https://library.securetrading.net || true
    - wget --content-on-error --no-check-certificate -O- https://merchant.securetrading.net || true
#    - wget -r --no-check-certificate https://webservices.securetrading.net:8443
    - google-chrome-stable --headless --dump-dom --disable-gpu --no-sandbox --ignore-certificate-errors "https://merchant.securetrading.net" > chrome_output.html
    - ls -lah
    - curl --insecure https://webservices.securetrading.net:8443/test
    - |
      curl --insecure -X POST \
      --data '{ "request": { "url": "/test", "method": "GET" }, "response": { "status": 200, "body": "Here it is test!\n" }}' \
      https://webservices.securetrading.net:8443/__admin/mappings/new
  artifacts:
    when: always
    expire_in: 1 week
    paths:
#      - merchant.securetrading.net
      - chrome_output.html
#      - webservices.securetrading.net

