<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Trust Payments Visa CTP Form</title>
    <meta name="description" content="Trust Payments example page with form">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <link rel="icon" href="./img/favicon.webp" sizes="32x32">
    <link rel="icon" href="./img/favicon.webp" sizes="192x192">
    <link rel="apple-touch-icon" href="./img/favicon.webp">
  </head>
  <body>
    <main>
      <header class="st-header">
        <figure class="st-header__logo">
          <img src="./img/trustpayments.png" alt="Trust Payments logo" title="Trust Payments" role="img">
        </figure>
        <h1 class="st-header__title">Visa CTP Form</h1>
      </header>
      <form role="form" name="st-form" id="st-form" action="https://www.example.com" class="st-form" autocomplete="off" novalidate>
        <div class="st-form__fieldset-wrapper">
          <fieldset class="st-form__fieldset">
            <legend>Billing details:</legend>
            <div class="st-form__section st-form__section--horizontal">
              <div class="st-form__field">
                <label for="st-form-title" class="st-form__label">
                  Title
                </label>
                <input type="text" name="title" id="st-form-title" class="st-form__input"/>
              </div>
              <div class="st-form__field">
                <label for="st-form-first-name" class="st-form__label">
                  First name
                </label>
                <input type="text" name="firstName" id="st-form-first-name" class="st-form__input"/>
              </div>
              <div class="st-form__field">
                <label for="st-form-last-name" class="st-form__label">
                  Last name
                </label>
                <input type="text" name="lastName" id="st-form-last-name" class="st-form__input"/>
              </div>
              <div class="st-form__field">
                <label for="st-form-house-name" class="st-form__label">
                  House name/no.
                </label>
                <input type="text" name="houseName" id="st-form-house-name" class="st-form__input"/>
              </div>
              <div class="st-form__field">
                <label for="st-form-street" class="st-form__label">
                  Street
                </label>
                <input type="text" name="street" id="st-form-street" class="st-form__input"/>
              </div>
              <div class="st-form__field">
                <label for="st-form-town" class="st-form__label">
                  Town
                </label>
                <input type="text" name="town" id="st-form-town" class="st-form__input"/>
              </div>
              <div class="st-form__field">
                <label for="st-form-county" class="st-form__label">
                  County
                </label>
                <input type="text" name="county" id="st-form-county" class="st-form__input"/>
              </div>
              <div class="st-form__field">
                <label for="st-form-country" class="st-form__label">
                  Country
                </label>
                <input type="text" name="country" id="st-form-country" class="st-form__input"/>
              </div>
              <div class="st-form__field">
                <label for="st-form-post-code" class="st-form__label">
                  Post code
                </label>
                <input type="text" name="postCode" id="st-form-post-code" class="st-form__input"/>
              </div>
              <div class="st-form__field">
                <label for="st-form-email" class="st-form__label">
                  Email
                </label>
                <input type="text" name="email" id="st-form-email" class="st-form__input"/>
              </div>
              <div class="st-form__field">
                <label for="st-form-telephone" class="st-form__label">
                  Telephone
                </label>
                <input type="text" name="telephone" id="st-form-telephone" class="st-form__input"/>
              </div>
              <div class="st-form__field">
                <label for="st-form-telephone-type" class="st-form__label">
                  Telephone type
                </label>
                <input type="text" name="telephoneType" id="st-form-telephone-type" class="st-form__input"/>
              </div>
            </div>
          </fieldset>
          <fieldset class="st-form__fieldset">
            <legend>Delivery details:</legend>
            <div class="st-form__section st-form__section--horizontal">
              <div class="st-form__field">
                <label for="st-form-title-d" class="st-form__label">
                  Title
                </label>
                <input type="text" name="dtitle" id="st-form-title-d" class="st-form__input"/>
              </div>
              <div class="st-form__field">
                <label for="st-form-first-name-d" class="st-form__label">
                  First name
                </label>
                <input type="text" name="dfirstName" id="st-form-first-name-d" class="st-form__input"/>
              </div>
              <div class="st-form__field">
                <label for="st-form-last-name-d" class="st-form__label">
                  Last name
                </label>
                <input type="text" name="dlastName" id="st-form-last-name-d" class="st-form__input"/>
              </div>
              <div class="st-form__field">
                <label for="st-form-house-name-d" class="st-form__label">
                  House name/no.
                </label>
                <input type="text" name="dhouseName" id="st-form-house-name-d" class="st-form__input"/>
              </div>
              <div class="st-form__field">
                <label for="st-form-street-d" class="st-form__label">
                  Street
                </label>
                <input type="text" name="dstreet" id="st-form-street-d" class="st-form__input"/>
              </div>
              <div class="st-form__field">
                <label for="st-form-town-d" class="st-form__label">
                  Town
                </label>
                <input type="text" name="dtown" id="st-form-town-d" class="st-form__input"/>
              </div>
              <div class="st-form__field">
                <label for="st-form-county-d" class="st-form__label">
                  County
                </label>
                <input type="text" name="dcounty" id="st-form-county-d" class="st-form__input"/>
              </div>
              <div class="st-form__field">
                <label for="st-form-country-d" class="st-form__label">
                  Country
                </label>
                <input type="text" name="dcountry" id="st-form-country-d" class="st-form__input"/>
              </div>
              <div class="st-form__field">
                <label for="st-form-post-code-d" class="st-form__label">
                  Post code
                </label>
                <input type="text" name="dpostCode" id="st-form-post-code-d" class="st-form__input"/>
              </div>
              <div class="st-form__field">
                <label for="st-form-email-d" class="st-form__label">
                  Email
                </label>
                <input type="text" name="demail" id="st-form-email-d" class="st-form__input"/>
              </div>
              <div class="st-form__field">
                <label for="st-form-telephone-d" class="st-form__label">
                  Telephone
                </label>
                <input type="text" name="dtelephone" id="st-form-telephone-d" class="st-form__input"/>
              </div>
              <div class="st-form__field">
                <label for="st-form-telephone-type-d" class="st-form__label">
                  Telephone type
                </label>
                <input type="text" name="dtelephoneType" id="st-form-telephone-type-d" class="st-form__input"/>
              </div>
            </div>
          </fieldset>
        </div>
        <fieldset class="st-form__fieldset">
          <legend>Payment details:</legend>
          <div class="st-form__section st-form__section" id="st-card-details-section">
            <div class="st-form__field">
              <label for="st-form-card-number" class="st-form__label">
                Card number:
                <abbr title="required" aria-label="required">*</abbr>
              </label>
              <input type="text" name="pan" id="st-form-card-number" class="st-form__input"/>
            </div>
            <div class="st-form__field">
              <label for="st-form-expiry-date-month" class="st-form__label">
                Expiry date:
                <abbr title="required" aria-label="required">*</abbr>
              </label>
              <div class="st-form-expiry-date-wrapper">
                <select name="expirymonth" id="st-form-expiry-date-month" class="st-form__input">
                  <option selected="selected" value=""></option>
                  <option value="01">01</option>
                  <option value="02">02</option>
                  <option value="03">03</option>
                  <option value="04">04</option>
                  <option value="05">05</option>
                  <option value="06">06</option>
                  <option value="07">07</option>
                  <option value="08">08</option>
                  <option value="09">09</option>
                  <option value="10">10</option>
                  <option value="11">11</option>
                  <option value="12">12</option>
                </select>
                <select name="expiryyear" id="st-form-expiry-date-year" class="st-form__input">
                  <option selected="selected" value=""></option>
                  <option value="2022">2022</option>
                  <option value="2023">2023</option>
                  <option value="2024">2024</option>
                  <option value="2025">2025</option>
                  <option value="2026">2026</option>
                  <option value="2027">2027</option>
                  <option value="2028">2028</option>
                  <option value="2029">2029</option>
                  <option value="2030">2030</option>
                  <option value="2031">2031</option>
                  <option value="2032">2032</option>
                  <option value="2033">2033</option>
                  <option value="2034">2034</option>
                  <option value="2035">2035</option>
                  <option value="2036">2036</option>
                  <option value="2037">2037</option>
                  <option value="2038">2038</option>
                  <option value="2039">2039</option>
                  <option value="2040">2040</option>
                  <option value="2041">2041</option>
                  <option value="2042">2042</option>
                </select>
              </div>
            </div>
            <div class="st-form__field">
              <label for="st-form-security-code" class="st-form__label">
                Security code:
                <abbr title="required" aria-label="required">*</abbr>
              </label>
              <input type="text" name="securitycode" id="st-form-security-code" class="st-form__input"/>
            </div>
            <div class="st-form__actions--wrapper">
              <div class="st-form__visa--ctp">
                <p>Click to pay <span id="st-ctp-separator">|</span> <span id="st-ctp-lookup-btn">Look up my cards</span></p>
                <div id="st-ctp-registration">
                  <input type="checkbox" id="register" name="register">
                  <label for="register">Register your card with Click to Pay for a faster checkout experience.</label>
                  <p><a href="#">Learn more about Click to Pay</a></p>
                </div>
              </div>
            </div>
          </div>
          <div class="st-form__section st-form__section">
            <div class="st-form__actions--wrapper">
              <div class="st-form__group st-form__group--submit">
                <button type="submit" class="st-form__button" id="merchant-submit-button">
                  Pay securely
                </button>
              </div>
            </div>
          </div>
        </fieldset>
        <div id="st-ctp-login"></div>
        <div id="st-ctp-cards"></div>
        <fieldset class="st-form__fieldset">
          <legend>Logs:</legend>
          <textarea id="st-log-area" rows="20" class="st-form__input"></textarea>
        </fieldset>
      </form>
    </main>
    <script type="text/javascript" src="<%= LIBRARY_URL %>/st.js"></script>
    <script type="text/javascript">
      var ST = SecureTrading;
      window.addEventListener('load', function () {
        var params = new URLSearchParams(window.location.search.substring(1));
        var inlineConfig = params.get('inlineConfig') ? JSON.parse(params.get('inlineConfig')) : '';
        var jwt = params.get('jwt') || '';

        Promise.all([getConfig()])
          .then(function (configValues) {
            var config = configValues[0];
            var st = init(config);
          });

        function getConfig() {
          if (inlineConfig) {
            return Promise.resolve(inlineConfig);
          }

          return window
            .fetch('<%= CONFIG_URL %>/config.json')
            .then(function (response) {
              if (response.status !== 200) {
                return Promise.reject('Failed to load configuration file!');
              }

              return response.json();
            })
            .then(function (config) {
              return getJwt(config).then(function (jwt) {
                return Object.assign(config, {jwt: jwt});
              });
            })
            .catch(function (error) {
              console.error(error);
            });
        }

        function getJwt(config) {
          var presetJwt = jwt || config.jwt;

          if (presetJwt) {
            return Promise.resolve(presetJwt);
          }

          return window.configJWT('<%= CONFIG_URL %>/jwtdata.json');
        }

        function init(config) {
          var st = ST(config);
          var clickToPayAdapterInitParams = { // TODO update init params
            formId: 'st-form',
            cardListContainerId: 'st-ctp-cards',
            signInContainerId: 'st-ctp-login',
            srciDpaId: 'TrustPayments-test-merchant',
            dpaTransactionOptions: {
              consumerNameRequested: false,
              consumerEmailAddressRequested: false,
              consumerPhoneNumberRequested: false,
              reviewAction: 'pay',
              transactionAmount: {
                transactionAmount: 100.00,
                transactionCurrencyCode: 'GBP',
              },
            },
            onUpdateView: onUpdateView,
          };

          st.ClickToPay({ adapter: 'hpp' })
            .then(function(adapter) {
              return adapter.init(clickToPayAdapterInitParams);
            })
            .then(function(adapter) {
              printLogs('CTP adapter is initialized');
              setLookupMyCardsClickListener(adapter);
              checkIfUserIsRecognized(adapter);
            })
            .catch(function(error) {
              console.error(error);
            });

          st.on('paymentInitStarted', function (data) {
            printLogs({name: data.name, step: 'PAYMENT INIT STARTED'});
          });
          st.on('paymentInitCompleted', function (data) {
            printLogs({name: data.name, step: 'PAYMENT INIT COMPLETED'});
          });
          st.on('paymentInitFailed', function (data) {
            printLogs({name: data.name, step: 'PAYMENT INIT FAILED'});
          });
          st.on('paymentStarted', function (data) {
            printLogs({name: data.name, step: 'PAYMENT STARTED'});
          });
          st.on('paymentCompleted', function (data) {
            printLogs({name: data.name, step: 'PAYMENT COMPLETED'});
          });
          st.on('paymentFailed', function (data) {
            printLogs({name: data.name, step: 'PAYMENT FAILED'});
          });
          st.on('paymentCanceled', function (data) {
            printLogs({name: data.name, step: 'PAYMENT CANCELED'});
          });

          return st;
        }

        function setLookupMyCardsClickListener(adapterInstance) {
          document.querySelector('#st-ctp-lookup-btn').addEventListener('click', function() {
            adapterInstance.identifyUser()
              .then(function (result) {
                printLogs('user identified: %s', result);
                if (result.isSuccessful) {
                  adapterInstance.showCardList();
                }
              })
              .catch(function (e) {
                console.error(e);
              });
          });
        }

        function checkIfUserIsRecognized(adapterInstance) {
          adapterInstance.isRecognized().then(function (isRecognized) {
            if (isRecognized) {
              adapterInstance.showCardList();
            }
          });
        }

        function onUpdateView(updateView) {
          var cardDetailsElement = document.getElementById('st-card-details-section');

          if (updateView.displayCardForm === true) {
            cardDetailsElement.classList.remove('hidden');
          }

          if (updateView.displayCardForm === false) {
            cardDetailsElement.classList.add('hidden');
          }
        }

        function printLogs(logs) {
          var outputElement = document.getElementById('st-log-area');

          if (typeof logs === 'object') {
            logs = JSON.stringify(logs, null, 2);
          }

          outputElement.value += '' + logs + '\n';
        }
      });
  </script>
  </body>
</html>
