<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <script src="https://songbirdstag.cardinalcommerce.com/edge/v1/songbird.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.0.0-beta.2/build/jwt-decode.cjs.min.js"></script>
  <script>
    function requestId() {
      return 'J-' + Math.random().toString(36).substring(2, length);
    }

    window.addEventListener('load', async () => {
      const jwt = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJhbTAzMTAuYXV0b2FwaSIsImlhdCI6MTYwMDQ0NDIwNS4xMTk0MjEsInBheWxvYWQiOnsiYmFzZWFtb3VudCI6IjIwMDAiLCJhY2NvdW50dHlwZWRlc2NyaXB0aW9uIjoiRUNPTSIsImN1cnJlbmN5aXNvM2EiOiJHQlAiLCJzaXRlcmVmZXJlbmNlIjoidGVzdF9qYW1lczM4NjQxIiwibG9jYWxlIjoiZW5fR0IifX0.gMsMnTkejAW2ZujUrVqCSkDlD5uFoK6MEXhpgHpMdD8';
      const updatedJwt = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJhbTAzMTAuYXV0b2FwaSIsImlhdCI6MTYwMDQ0NDIyMS42ODg4NzQyLCJwYXlsb2FkIjp7ImJhc2VhbW91bnQiOiIyMDAwIiwiYWNjb3VudHR5cGVkZXNjcmlwdGlvbiI6IkVDT00iLCJjdXJyZW5jeWlzbzNhIjoiRVVSIiwic2l0ZXJlZmVyZW5jZSI6InRlc3RfamFtZXMzODY0MSIsImxvY2FsZSI6ImVuX0dCIn19.qIMP7L3FJ1klYJI0uAjmYCMJR9Rmr7BemKOo9EFs5Ic';
      const gatewayUrl = 'https://webservices.securetrading.net/jwt/';
      const pan = '5200000000001005';

      const jsInitRequest = (jwt) => ({
        acceptcustomeroutput: "1.00",
        jwt: jwt,
        request: [
          {
            requesttypedescriptions: ["JSINIT"],
            requestid: requestId(),
            sitereference: "test_james38641"
          }
        ],
        version: "1.00",
        versioninfo: "STJS::N/A::2.5.0::N/A",
      });

      // JSINIT

      const response = await fetch(gatewayUrl, {
        method: 'POST',
        body: JSON.stringify(jsInitRequest(jwt)),
      })
        .then(response => response.json())
        .then(response => jwtDecode(response.jwt));

      console.log('JSINIT RESPONSE', response.payload.response[0]);

      const cardinalJwt = response.payload.response[0].threedinit;
      const cardinalCacheToken = response.payload.response[0].cachetoken;

      // CARDINAL SETUP

      Cardinal.setup('init', {jwt: cardinalJwt});

      // JSINIT 2

      const response2 = await fetch(gatewayUrl, {
        method: 'POST',
        body: JSON.stringify(jsInitRequest(updatedJwt)),
      })
        .then(response => response.json())
        .then(response => jwtDecode(response.jwt));

      console.log('JSINIT RESPONSE', response2.payload.response[0]);

      const cardinalJwt2 = response2.payload.response[0].threedinit;
      const cardinalCacheToken2 = response2.payload.response[0].cachetoken;

      // CARDINAL SETUP 2

      Cardinal.setup('init', {jwt: cardinalJwt2});

      // THREEDQUERY

      const threedQueryRequest = {
        acceptcustomeroutput: "1.00",
        jwt: updatedJwt,
        request: [
          {
            termurl: "https://termurl.com",
            cachetoken: cardinalCacheToken2,
            requesttypedescriptions: ["THREEDQUERY"],
            pan: pan,
            expirydate: "01/23",
            securitycode: "123",
            requestid: requestId(),
            sitereference: "test_james38641",
          }
        ],
        version: "1.00",
        versioninfo: "STJS::N/A::2.5.0::N/A",
      };

      const threeDResponse = await fetch(gatewayUrl, {
        method: 'POST',
        body: JSON.stringify(threedQueryRequest),
      })
        .then(response => response.json())
        .then(response => jwtDecode(response.jwt));

      console.log('THREEDQUERY RESPONSE', threeDResponse.payload.response[0]);

      const acsUrl = threeDResponse.payload.response[0].acsurl;
      const payload = threeDResponse.payload.response[0].threedpayload;
      const transactionId = threeDResponse.payload.response[0].acquirertransactionreference;

      //
      //
      // if (acsUrl) {
      //   Cardinal.continue(
      //     'cca',
      //     {
      //       AcsUrl: acsUrl,
      //       Payload: payload
      //     },
      //     {
      //       Cart: [],
      //       OrderDetails: {
      //         TransactionId: transactionId
      //       }
      //     },
      //     cardinalJwt
      //   );
      // }

      const authRequest = {
        acceptcustomeroutput: "1.00",
        jwt: updatedJwt,
        request: [
          {
            requesttypedescriptions: ["AUTH"],
            pan: pan,
            expirydate: "01/23",
            securitycode: "123",
            requestid: requestId(),
            sitereference: "test_james38641"
          },
        ],
        version: "1.00",
        versioninfo: "STJS::N/A::2.5.0::N/A"
      };

      const authResponse = await fetch(gatewayUrl, {
        method: 'POST',
        body: JSON.stringify(authRequest),
      })
        .then(response => response.json())
        .then(response => jwtDecode(response.jwt));

      console.log('AUTH RESPONSE', authResponse.payload.response[0]);
    });
  </script>
</head>
<body>

</body>
</html>
